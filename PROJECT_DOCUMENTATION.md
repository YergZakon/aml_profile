# Документация системы мониторинга транзакций АФМ РК

## Общее описание проекта

Система мониторинга транзакций для Агентства по финансовому мониторингу Республики Казахстан (АФМ РК). Проект состоит из backend на Python/Flask и frontend на React/Vite.

## Структура проекта

```
profile/
├── aml-backend/               # Backend часть системы
├── aml-monitoring-frontend/   # Frontend часть системы
├── do_range.json             # Тестовые данные транзакций
├── run-dev.js                # Скрипт для запуска dev окружения
├── start-dev.bat             # Batch файл для Windows
├── start-system.bat          # Batch файл для запуска системы
└── Описание профилей/        # Документация по профилям анализа
```

## Backend (aml-backend/)

### Основные файлы

#### 1. **app.py**
**Назначение**: Главный файл Flask приложения, содержит все API endpoints.

**Основные функции**:
- Инициализация Flask приложения и CORS
- TUS протокол для загрузки больших файлов
- REST API endpoints:
  - `/upload` - загрузка файлов через TUS протокол
  - `/api/analytics/dashboard` - данные для дашборда
  - `/api/transactions` - список транзакций с фильтрацией
  - `/api/analytics/risk-analysis` - анализ рисков
  - `/api/transactions/<id>` - детали транзакции
  - `/api/transactions/export` - экспорт в CSV
- Автоматический поиск последней БД при запуске
- Запуск анализа в фоновом потоке после загрузки файла

#### 2. **aml_database_setup.py**
**Назначение**: Управление SQLite базой данных.

**Основные классы и функции**:
- `AMLDatabaseManager` - главный класс для работы с БД
- Создание схемы БД (8 таблиц):
  - `customer_profiles` - профили клиентов
  - `transactions` - транзакции
  - `network_connections` - сетевые связи
  - `detected_schemes` - обнаруженные схемы
  - `behavioral_history` - история поведения
  - `geographic_corridors` - географические коридоры
  - `alerts` - алерты и уведомления
  - `system_settings` - системные настройки
- Методы для сохранения и получения данных
- Аналитические запросы (`get_system_statistics`, `get_high_risk_customers` и др.)

#### 3. **aml_integration_system.py**
**Назначение**: Интеграционная система, объединяющая все профили анализа.

**Основные функции**:
- `AMLIntegrationSystem` - главный класс интеграции
- `run_full_analysis()` - запуск полного цикла анализа:
  - Загрузка данных из JSON
  - Анализ каждой транзакции через все профили
  - Сохранение результатов в `analysis_results.json`
- Координация работы всех аналитических профилей

#### 4. **aml_json_loader.py**
**Назначение**: Загрузка данных из JSON файлов в базу данных.

**Основные функции**:
- `AMLJSONDataLoader` - класс для загрузки данных
- Парсинг JSON структуры из файла `do_range.json`
- Извлечение участников транзакций
- Преобразование данных в формат БД
- Подсчет статистики загрузки

### Аналитические профили

#### 5. **transaction_profile_afm.py**
**Назначение**: Анализ транзакций на уровне отдельных операций.

**Основные функции**:
- Проверка пороговых значений (2М для наличных, 7М для переводов)
- Выявление подозрительных паттернов:
  - Круглые суммы
  - Множественные транзакции
  - Операции в нерабочее время
- Расчет риск-скора транзакции

#### 6. **customer_profile_afm.py**
**Назначение**: Анализ профилей клиентов.

**Основные функции**:
- Оценка базового риска клиента
- Учет факторов:
  - Тип клиента (физ/юр лицо)
  - PEP статус
  - Страна резидентства
  - История подозрительных операций
- Расчет общего риск-скора клиента

#### 7. **network_profile_afm.py**
**Назначение**: Анализ сетевых связей между участниками.

**Основные функции**:
- Построение графа связей
- Обнаружение схем:
  - Круговые переводы
  - Звездообразные структуры
  - Транзитные схемы
  - Дробление (smurfing)
- Анализ сетевых метрик

#### 8. **behavioral_profile_afm.py**
**Назначение**: Анализ поведенческих паттернов.

**Основные функции**:
- Построение базового профиля поведения
- Обнаружение аномалий:
  - Резкое изменение объемов
  - Новые контрагенты
  - Изменение времени активности
- Статистический анализ отклонений

#### 9. **geographic_profile_afm.py**
**Назначение**: Географический анализ транзакций.

**Основные функции**:
- Оценка риска стран
- Анализ географических коридоров
- Выявление офшорных зон
- Проверка санкционных списков
- Анализ необычных маршрутов платежей

### Вспомогательные файлы

#### 10. **aml_codes_config.py**
**Назначение**: Конфигурация кодов подозрительности АФМ.

**Содержание**:
- Словарь кодов подозрительных операций
- Категории подозрительности
- Функции для работы с кодами

#### 11. **analyze_suspicious_clients.py**
**Назначение**: Утилита для анализа подозрительных клиентов.

**Функции**:
- Загрузка данных из БД
- Группировка по клиентам
- Подсчет статистики подозрительности
- Экспорт результатов

#### 12. **requirements.txt**
**Назначение**: Зависимости Python проекта.

**Основные пакеты**:
- Flask и flask-cors для веб-сервера
- SQLite3 для БД
- NumPy и SciPy для анализа
- NetworkX для графового анализа

## Frontend (aml-monitoring-frontend/)

### Основные файлы

#### 1. **src/main.jsx**
**Назначение**: Точка входа React приложения.

**Функции**:
- Инициализация React
- Подключение глобальных стилей
- Рендеринг корневого компонента

#### 2. **src/app.jsx**
**Назначение**: Главный компонент приложения.

**Функции**:
- Настройка React Router
- Определение маршрутов
- Общий layout с навигацией

### Страницы (src/pages/)

#### 3. **DashboardPage.jsx**
**Назначение**: Главная страница с общей статистикой.

**Функции**:
- Отображение ключевых метрик
- График распределения рисков
- Список последних алертов
- Автообновление данных

#### 4. **TransactionsPage.jsx**
**Назначение**: Страница списка транзакций.

**Функции**:
- Таблица транзакций с пагинацией
- Фильтры по риску, дате, поиск
- Сортировка
- Экспорт в CSV

#### 5. **AnalysisPage.jsx**
**Назначение**: Страница анализа рисков.

**Функции**:
- Статистика по уровням риска
- Список подозрительных транзакций
- Топ индикаторов риска
- Фильтры по типу анализа

#### 6. **UploadPage.jsx**
**Назначение**: Страница загрузки файлов.

**Функции**:
- Drag & drop интерфейс
- Загрузка через TUS протокол
- Отображение прогресса
- История загрузок

#### 7. **HistoryPage.jsx**
**Назначение**: История операций и анализов.

**Функции**:
- Список проведенных анализов
- Детали каждого анализа
- Возможность повторного просмотра

#### 8. **SettingsPage.jsx**
**Назначение**: Настройки системы.

**Функции**:
- Пороговые значения
- Настройки анализа
- Управление правилами
- Экспорт/импорт конфигурации

### Компоненты (src/components/)

#### 9. **FileUploader.jsx**
**Назначение**: Компонент загрузки файлов.

**Функции**:
- Поддержка TUS протокола
- Drag & drop
- Прогресс загрузки
- Обработка ошибок

#### 10. **TransactionDetailsModal.jsx**
**Назначение**: Модальное окно с деталями транзакции.

**Функции**:
- Полная информация о транзакции
- Результаты анализа по профилям
- Индикаторы риска
- История изменений

#### 11. **PieChart.jsx**
**Назначение**: Компонент круговой диаграммы.

**Функции**:
- Визуализация распределения рисков
- Интерактивность
- Адаптивность

### Сервисы (src/services/)

#### 12. **api.js**
**Назначение**: Модуль для работы с API.

**Функции**:
- Настройка axios
- Методы для всех API endpoints
- Обработка ошибок
- Интерсепторы для токенов

### Конфигурационные файлы

#### 13. **vite.config.js**
**Назначение**: Конфигурация Vite сборщика.

**Настройки**:
- Прокси для API
- Алиасы путей
- Оптимизация сборки

#### 14. **tailwind.config.js**
**Назначение**: Конфигурация Tailwind CSS.

**Настройки**:
- Цветовая схема
- Кастомные классы
- Responsive breakpoints

#### 15. **package.json**
**Назначение**: Конфигурация npm проекта.

**Содержание**:
- Зависимости (React, Vite, Tailwind и др.)
- Скрипты запуска
- Метаданные проекта

## Вспомогательные файлы в корне

#### 16. **run-dev.js**
**Назначение**: Node.js скрипт для запуска dev окружения.

**Функции**:
- Одновременный запуск backend и frontend
- Управление процессами
- Логирование

#### 17. **start-dev.bat**
**Назначение**: Windows batch файл для быстрого запуска.

**Функции**:
- Активация виртуального окружения
- Запуск обоих серверов
- Обработка ошибок

#### 18. **do_range.json**
**Назначение**: Тестовые данные транзакций.

**Содержание**:
- 1000 транзакций
- Реальная структура данных АФМ
- Различные типы операций

## База данных

### Структура таблиц

1. **customer_profiles** - профили клиентов с риск-скорингом
2. **transactions** - все транзакции с результатами анализа
3. **network_connections** - связи между участниками
4. **detected_schemes** - обнаруженные схемы отмывания
5. **behavioral_history** - история поведения клиентов
6. **geographic_corridors** - статистика по географическим маршрутам
7. **alerts** - сгенерированные алерты и СПО
8. **system_settings** - системные настройки и пороги

### Именование файлов БД

- Формат: `aml_system_[уникальный_id].db`
- Создается новая БД для каждого загруженного файла
- Автоматический поиск последней БД при запуске

## Процесс работы системы

1. **Загрузка данных**: Пользователь загружает JSON файл через веб-интерфейс
2. **Создание БД**: Система создает новую БД с уникальным ID
3. **Импорт данных**: JSON данные импортируются в БД
4. **Анализ**: Запускается полный цикл анализа через все профили
5. **Сохранение результатов**: Результаты сохраняются в БД и JSON
6. **Отображение**: Frontend отображает результаты анализа
7. **Экспорт**: Возможность экспорта отчетов и данных 